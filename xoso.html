<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Xổ Số Siêu Tốc — Demo 1.0</title>
  <style>
    :root{
      --bg:#071227;--card:#071928;--accent:#f9d34c;--accent-2:#22c55e;--muted:#94a3b8;--glass:rgba(255,255,255,0.06);
      --glass-2:rgba(255,255,255,0.03);--danger:#ef4444;--success:#10b981;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#041022 0%, #051326 60%);color:#e6eef8;-webkit-font-smoothing: antialiased;-moz-osx-font-smoothing: grayscale;}
    .app{max-width:1150px;margin:20px auto;padding:16px;display:grid;grid-template-columns:1fr 340px;gap:16px}
    header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}
    header h1{margin:0;font-size:22px;font-weight:700;color:#f9d34c;text-shadow: 0 0 6px #f9d34c;}
    .muted{color:var(--muted);font-size:13px;line-height:1.3}

    .card{background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));border-radius:12px;padding:20px;box-shadow:0 8px 24px rgba(2,6,23,0.8);border:1px solid rgba(255,255,255,0.06);color:#e6eef8}

    /* center */
    .center{padding:12px}
    .board{display:flex;flex-direction:column;gap:18px}
    .label{font-size:14px;color:var(--accent);margin-bottom:8px;font-weight:600;text-shadow: 0 0 4px #f9d34c;}

    .your-numbers{display:flex;gap:12px;flex-wrap:wrap}
    .two-digit{width:72px;height:72px;border-radius:14px;background:var(--glass);display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:700;color:#f9d34c;border:1.5px solid rgba(249,211,76,0.6);box-shadow: 0 0 8px rgba(249,211,76,0.5);}
    .two-digit input{width:100%;height:100%;background:transparent;border:0;outline:none;color:inherit;text-align:center;font-size:26px;font-weight:700;letter-spacing:0.1em;-moz-:textfield;}
    .two-digit input::-webkit-inner-spin-button, .two-digit input::-webkit-outer-spin-button {-webkit-appearance:none;margin:0;}

    .result-row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    .result-slot{width:56px;height:56px;border-radius:12px;background:linear-gradient(180deg,#0a1a3a,#0f2a5a);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:22px;color:#22c55e;border:1.5px solid rgba(34,197,94,0.7);text-shadow: 0 0 6px #22c55e;}
    .controls{display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:center;margin-top:0px}
    .bet-type{padding:12px 16px;border-radius:14px;border:1.5px solid rgba(255,255,255,0.06);cursor:pointer;min-width:130px;text-align:center;font-weight:700;color:#f9d34c;user-select:none;transition: all 0.3s ease;}
    .bet-type small{font-weight:400;color:var(--muted);display:block;margin-top:0px;font-size:12px;}
    .bet-type.active{box-shadow:0 0 12px 3px rgba(249,211,76,0.7);border-color:rgba(249,211,76,0.9);transform:translateY(-3px);background:rgba(249,211,76,0.1);}

    .bet-amount{width:240px;padding:12px 14px;border-radius:14px;border:1.5px solid rgba(255,255,255,0.06);background:transparent;color:#f9d34c;font-weight:700;font-size:16px;box-shadow: inset 0 0 8px rgba(249,211,76,0.3);text-align:center;letter-spacing:0.05em;}
    .bet-amount::placeholder{color:var(--muted);font-weight:500;}

    .btn{padding:14px 22px;border-radius:14px;border:0;cursor:pointer;font-weight:700;letter-spacing:0.05em;transition: all 0.3s ease;box-shadow: 0 0 8px rgba(249,211,76,0.5);}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#ffd46b);color:#071124;text-shadow: 0 0 4px #7a5a00;}
    .btn.primary:hover:not(:disabled){filter:brightness(1.1);}
    .btn.primary:disabled{opacity:0.5;cursor:not-allowed;box-shadow:none;}
    .btn.ghost{background:transparent;border:1.5px solid rgba(255,255,255,0.06);color:#f9d34c;text-shadow: 0 0 4px #f9d34c;}
    .btn.ghost:hover:not(:disabled){background:rgba(249,211,76,0.1);border-color:rgba(249,211,76,0.8);}
    .btn.ghost:disabled{opacity:0.5;cursor:not-allowed;}

    .sidebar{display:flex;flex-direction:column;gap:16px}
    .info-row{display:flex;justify-content:space-between;align-items:center;font-weight:600;color:#f9d34c;font-size:15px;}
    .info-row div.muted{font-weight:400;color:var(--muted);font-size:14px;}
    .history{max-height:360px;overflow-y:auto;padding:12px;border-radius:14px;background:var(--glass-2);box-shadow: inset 0 0 12px rgba(255,255,255,0.05);}
    .history-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;margin-bottom:10px;font-size:14px;line-height:1.2;box-shadow: 0 0 6px rgba(0,0,0,0.3);}
    .win{background:linear-gradient(90deg, rgba(34,197,94,0.12), rgba(34,197,94,0.05));border:1.5px solid rgba(34,197,94,0.15);color:#22c55e;}
    .lose{background:linear-gradient(90deg, rgba(239,68,68,0.07), rgba(239,68,68,0.02));border:1.5px solid rgba(239,68,68,0.08);color:#ef4444;}

    footer{grid-column:1/-1;text-align:center;padding:12px;color:var(--muted);font-size:14px;font-weight:500;letter-spacing:0.05em;}

    /* modals */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.85);display:flex;align-items:center;justify-content:center;z-index:60;backdrop-filter: blur(6px);}
    .modal{width:min(820px,96%);background:linear-gradient(180deg,#071029,#071527);padding:24px;border-radius:16px;border:1.5px solid rgba(255,255,255,0.06);color:#f9d34c;box-shadow: 0 0 20px rgba(249,211,76,0.7);font-weight:600;}
    .modal h2, .modal h3{margin-top:0;margin-bottom:12px;color:#f9d34c;text-shadow: 0 0 6px #f9d34c;}
    .modal ul{padding-left:20px;margin-top:8px;}
    .modal ul li{margin-bottom:8px;font-weight:500;color:#e6eef8;}
    .modal a{color:#ffd46b;text-decoration:underline;}
    .modal a:hover{text-decoration:none;}

    /* shop grid */
    .shop-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-top:12px;}
    .shop-card{background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));padding:16px;border-radius:14px;border:1.5px solid rgba(255,255,255,0.06);color:#f9d34c;box-shadow: 0 0 10px rgba(249,211,76,0.4);}
    .shop-card div.muted{font-size:13px;color:var(--muted);margin-bottom:12px;}
    .shop-card button{width:100%;padding:10px 0;border-radius:12px;font-weight:700;letter-spacing:0.05em;box-shadow: 0 0 6px rgba(249,211,76,0.5);}
    .shop-card button:hover{filter:brightness(1.1);}

    /* responsive */
    @media (max-width:980px){
      .app{grid-template-columns:1fr;padding:12px}
      .sidebar{order:2}
      .your-numbers{justify-content:center}
      .result-row{justify-content:center}
      .controls{justify-content:center}
      header{justify-content:center;text-align:center;}
    }
    @media (max-width:480px){
      .two-digit{width:56px;height:56px;font-size:20px;}
      .result-slot{width:48px;height:48px;font-size:18px;}
      .bet-type{min-width:100px;padding:10px 12px;font-size:14px;}
      .bet-amount{width:180px;font-size:14px;padding:10px 12px;}
      .btn{padding:10px 16px;font-size:14px;}
    }
    /* thêm vào phần <style> của bạn */
#confettiCanvas{
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 50; /* thấp hơn modal (modal có z-index:60 trong code) */
  display: block;
}

  </style>
</head>
<!-- START: Dopi Telegram FAB (self-contained) -->
<a href="https://t.me/dopinews"
   class="dopi-telegram-fab"
   target="_blank"
   rel="noopener noreferrer"
   aria-label="Mở Telegram DopiNews (mở tab mới)"
   title="Nhắn tin / Theo dõi trên Telegram — DopiNews">
  <svg viewBox="0 0 240 240" aria-hidden="true" focusable="false">
    <path d="M120 0C53.7 0 0 53.7 0 120s53.7 120 120 120 120-53.7 120-120S186.3 0 120 0zm55.7 81.3l-19.3 90.9c-1.5 6.1-5.6 7.6-11.4 4.7l-31.5-23.2-15.2 14.6c-1.7 1.7-3.1 3.1-6.3 3.1l2.3-32.6L169 86.1c3.9-3.4-0.8-5.3-6-1.9L69.6 132.9 43.1 122.3c-6.1-1.9-6.2-6.1 1.3-9.1L201.1 58.2c5.8-1.9 10.9 3.9 6.6 23.1z"/>
  </svg>
</a>

<style>
/* Scoped styles: .dopi-telegram-fab to avoid conflicts */
.dopi-telegram-fab{
  position: fixed;
  right: 20px;
  bottom: 20px;
  width: 64px;
  height: 64px;
  border-radius: 50%;
  display: inline-grid;
  place-items: center;
  background: linear-gradient(135deg,#0088cc 0%, #00a7e6 100%);
  box-shadow: 0 8px 24px rgba(3,86,134,0.28);
  z-index: 55; /* default: under modals z-index:60 */
  transform: translateZ(0);
  transition: transform .18s cubic-bezier(.2,.9,.2,1), box-shadow .18s ease, filter .18s ease;
  text-decoration: none;
  -webkit-tap-highlight-color: transparent;
}

/* SVG icon styling */
.dopi-telegram-fab svg{
  width: 36px;
  height: 36px;
  display: block;
  filter: drop-shadow(0 1px 0 rgba(255,255,255,0.06));
  transition: transform .18s ease;
}

/* Hover + focus */
.dopi-telegram-fab:hover,
.dopi-telegram-fab:focus{
  transform: translateY(-6px) scale(1.03);
  box-shadow: 0 18px 40px rgba(3,86,134,0.28);
  outline: none;
  filter: saturate(1.05);
}
.dopi-telegram-fab:hover svg{
  transform: rotate(-12deg) translateY(-2px);
}

/* Keyboard visibility */
.dopi-telegram-fab:focus-visible{
  box-shadow: 0 0 0 4px rgba(0,167,230,0.18), 0 18px 40px rgba(3,86,134,0.28);
  border-radius: 50%;
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce){
  .dopi-telegram-fab,
  .dopi-telegram-fab svg{ transition: none; transform: none; }
}

/* Responsive */
@media (max-width:420px){
  .dopi-telegram-fab{ width:54px; height:54px; right:14px; bottom:14px; }
  .dopi-telegram-fab svg{ width:30px; height:30px;}
}
</style>
<!-- END: Dopi Telegram FAB -->

<body>
  <canvas id="confettiCanvas"></canvas>
  <div class="app" role="main" aria-label="Xổ Số Siêu Tốc">
    <header>
      <h1>🎰 Xổ Số Siêu Tốc — Demo 1.0</h1>
      <div class="muted" aria-live="polite">Shop game Dopi | Không liên quan tiền thật · Lưu localStorage</div>
    </header>

    <main class="card center" aria-label="Khu vực chơi xổ số">
      <div class="board">
        <section aria-label="Lưu ý trò chơi">
          <div class="label">Lưu ý</div>
          <div class="muted">Trò chơi chỉ để giải trí. Dữ liệu lưu cục bộ trên trình duyệt — xóa cache hoặc đổi thiết bị sẽ mất dữ liệu.</div>
        </section>

        <section aria-label="Dãy số của bạn">
          <div class="label">Dãy Số Của Bạn</div>
          <div class="your-numbers" role="group" aria-describedby="desc-your-numbers">
            <div class="two-digit"><input maxlength="2" inputmode="numeric" pattern="[0-9]*" id="slot1" placeholder="00" aria-label="Ô số thứ nhất"></div>
            <div class="two-digit"><input maxlength="2" inputmode="numeric" pattern="[0-9]*" id="slot2" placeholder="00" aria-label="Ô số thứ hai"></div>
            <div class="two-digit"><input maxlength="2" inputmode="numeric" pattern="[0-9]*" id="slot3" placeholder="00" aria-label="Ô số thứ ba"></div>
            <div class="two-digit"><input maxlength="2" inputmode="numeric" pattern="[0-9]*" id="slot4" placeholder="00" aria-label="Ô số thứ tư"></div>
            <div class="two-digit"><input maxlength="2" inputmode="numeric" pattern="[0-9]*" id="slot5" placeholder="00" aria-label="Ô số thứ năm"></div>
          </div>
          <div id="desc-your-numbers" class="muted" style="margin-top:4px; font-size:12px;">Nhập 5 ô số, mỗi ô 2 chữ số từ 00 đến 99.</div>
        </section>

        <section aria-label="Kết quả hệ thống">
          <div class="label">Kết Quả Hệ Thống</div>
          <div class="result-row" id="resultRow" role="list" aria-live="polite" aria-atomic="true">
            <div class="result-slot" role="listitem" aria-label="Kết quả số 1">?</div>
            <div class="result-slot" role="listitem" aria-label="Kết quả số 2">?</div>
            <div class="result-slot" role="listitem" aria-label="Kết quả số 3">?</div>
            <div class="result-slot" role="listitem" aria-label="Kết quả số 4">?</div>
            <div class="result-slot" role="listitem" aria-label="Kết quả số 5">?</div>
            <div class="result-slot" role="listitem" aria-label="Kết quả số 6">?</div>
          </div>
        </section>

        <section aria-label="Chọn loại cược và đặt cược">
          <div class="label">Chọn Loại Cược</div>
          <div class="controls" role="radiogroup" aria-label="Chọn loại cược">
            <div class="bet-type active" data-type="2" id="bet2" role="radio" aria-checked="true" tabindex="0" aria-label="Cược 2 số cuối, tỉ lệ x3.75">2 SỐ CUỐI<br><small class="muted">x3.75</small></div>
            <div class="bet-type" data-type="4" id="bet4" role="radio" aria-checked="false" tabindex="-1" aria-label="Cược 4 số cuối, tỉ lệ x6.75">4 SỐ CUỐI<br><small class="muted">x6.75</small></div>
            <div class="bet-type" data-type="6" id="bet6" role="radio" aria-checked="false" tabindex="-1" aria-label="Cược 6 số, tỉ lệ x15.95">6 SỐ<br><small class="muted">x15.95</small></div>
          </div>
          <input id="betAmount" class="bet-amount" placeholder="Cược từ 10.000 - 100.000" aria-label="Nhập số tiền cược" inputmode="numeric" pattern="[0-9]*" />
          <div class="controls" style="justify-content:center;gap:16px;margin-top:8px;">
            <button id="openBtn" class="btn primary" aria-live="polite" aria-busy="false">MỞ THƯỞNG</button>
            <button id="rulesBtn" class="btn ghost">Luật & Tùy Chọn</button>
          </div>
        </section>

        <div id="message" class="muted" style="min-height:26px;text-align:center;font-weight:700" aria-live="assertive" aria-atomic="true"></div>
      </div>
    </main>

    <aside class="sidebar card" aria-label="Thông tin người chơi và lịch sử">
      <section aria-label="Thông tin người chơi">
        <div class="label">Thông tin người chơi</div>
        <div class="info-row"><div>ID</div><div id="playerId" class="muted" aria-live="polite">-</div></div>
        <div class="info-row"><div>Điểm</div><div id="playerPoints" aria-live="polite">0</div></div>
        <div class="info-row"><div>Điểm Shop</div><div id="shopPoints" aria-live="polite">0</div></div>
        <div class="info-row"><div>Tỷ lệ thắng (lý thuyết)</div><div id="winRate" class="muted" aria-live="polite">-</div></div>
        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center;">
          <button id="depositBtn" class="btn ghost" aria-label="Nạp 100.000 điểm">Nạp 100.000 Điểm</button>
          <button id="resetBtn" class="btn ghost" aria-label="Reset tài khoản">Reset Tài Khoản</button>
        </div>
      </section>

      <section aria-label="Lịch sử cược" style="margin-top:20px;">
        <div class="label">Lịch sử cược</div>
        <div class="history" id="historyList" tabindex="0" aria-live="polite" aria-atomic="false" aria-label="Danh sách lịch sử cược"></div>
      </section>

      <section aria-label="Các chức năng khác" style="margin-top:20px;">
        <div class="label">Các chức năng khác</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;">
          <button id="shopBtn" class="btn primary" aria-label="Mở shop đổi quà">Shop Đổi Quà</button>
          <button id="otherGame1" class="btn ghost" aria-label="Chơi game Chẵn Lẻ">Game Chẵn Lẻ</button>
          <button id="otherGame2" class="btn ghost" aria-label="Chơi game Xúc Xắc">Game Xúc Xắc</button>
        </div>
      </section>
    </aside>

    <footer>Shop game Dopi | Demo 1.0</footer>
  </div>

  <!-- MODALS -->
  <div id="welcomeModal" class="modal-backdrop" style="display:none" role="dialog" aria-modal="true" aria-labelledby="welcomeTitle" aria-describedby="welcomeDesc">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <h2 id="welcomeTitle">🎉 Chào mừng đến với Xổ Số Siêu Tốc</h2>
          <div id="welcomeDesc" class="muted" style="max-width:480px;line-height:1.4;">Trò chơi chỉ để giải trí. Không có tiền thật. Dữ liệu lưu cục bộ (localStorage) — mất khi xóa cache hoặc đổi thiết bị.</div>
        </div>
        <button id="closeWelcome" class="btn primary" aria-label="Bắt đầu chơi">Bắt đầu</button>
      </div>
    </div>
  </div>

  <div id="rulesModal" class="modal-backdrop" style="display:none" role="dialog" aria-modal="true" aria-labelledby="rulesTitle" aria-describedby="rulesDesc">
    <div class="modal">
      <h3 id="rulesTitle">Luật chơi & Tùy chọn</h3>
      <div id="rulesDesc" class="muted" style="margin-top:8px;line-height:1.4;">
        <ul>
          <li>Cược 2 số cuối: so sánh 2 chữ số ở ô thứ 3 (ô cuối) với 2 chữ số cuối của kết quả. Thưởng x3.75.</li>
          <li>Cược 4 số cuối: so sánh ô 2+3 với 4 chữ số cuối của kết quả. Thưởng x6.75.</li>
          <li>Cược 6 số: so sánh toàn bộ 6 chữ số. Thưởng x15.95.</li>
          <li>Giá trị số nhập phải là 00 - 99 cho mỗi ô. Cược tối thiểu 10.000, tối đa 100.000 và không vượt quá điểm hiện có.</li>
          <li>Nạp 100.000 điểm 1 lần/ngày bằng nút Nạp. Reset tài khoản sẽ xóa dữ liệu localStorage.</li>
          <li>Shop: cược ≥50.000 sẽ nhận ngẫu nhiên 100-500 ShopPoints để đổi quà.</li>
          <li>Liên kết: <a href="index.html">Game Chẵn Lẻ</a> · <a href="xucsac.html">Game Xúc Xắc</a></li>
        </ul>
      </div>
      <div style="display:flex;justify-content:flex-end;margin-top:16px">
        <button id="closeRules" class="btn primary" aria-label="Đóng luật chơi">Đóng</button>
      </div>
    </div>
  </div>

  <div id="shopModal" class="modal-backdrop" style="display:none" role="dialog" aria-modal="true" aria-labelledby="shopTitle" aria-describedby="shopDesc">
    <div class="modal">
      <h3 id="shopTitle">Shop Đổi Quà</h3>
      <div id="shopDesc" class="muted" style="margin-top:8px">Bạn có <strong id="shopPointsInModal">0</strong> ShopPoints.</div>

      <div style="margin-top:12px" class="shop-grid" id="shopGrid" tabindex="0" aria-label="Danh sách món quà trong shop"></div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:18px;flex-wrap:wrap;gap:12px">
        <button id="closeShop" class="btn ghost" aria-label="Đóng shop">Đóng</button>
        <div>
          <button id="buy50kPoints" class="btn primary" aria-label="Mua gói 50k điểm">Mua Gói 50k (500 ShopPoints)</button>
        </div>
      </div>
    </div>
  </div>

  <div id="promptModal" class="modal-backdrop" style="display:none" role="dialog" aria-modal="true" aria-labelledby="promptTitle" aria-describedby="promptContent">
    <div class="modal" style="max-height: 80vh; overflow-y: auto;">
      <h3 id="promptTitle">Mẫu Prompt CV</h3>
      <pre id="promptContent" style="white-space:pre-wrap;background:rgba(0,0,0,0.2);padding:12px;border-radius:8px;max-height:320px;overflow:auto;color:#f9d34c;font-weight:600;"></pre>
      <div style="display:flex;justify-content:flex-end;margin-top:12px">
        <button id="closePrompt" class="btn primary" aria-label="Đóng mẫu prompt">Đóng</button>
      </div>
    </div>
  </div>

  <audio id="spinSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_3a7a7a3a7a.mp3?filename=slot-machine-spin-2-6293.mp3" preload="auto"></audio>
  <audio id="winSound" src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_1a2b3c4d5e.mp3?filename=winning-fanfare-6343.mp3" preload="auto"></audio>

  <script>
    // ---------- Storage & defaults ----------
    const STORAGE_KEY = 'xoso_dopi_v1';
    const DEFAULTS = {playerID: null, playerPoints: 100000, shopPoints: 0, betHistory: [], lastDepositDate: null};

    // ---------- Utilities ----------
    function randomId(len = 8){const chars='ABCDEFGHJKMNPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';let s='';const arr=new Uint32Array(len);crypto.getRandomValues(arr);for(let i=0;i<len;i++){s+=chars[arr[i]%chars.length]}return 'Dopi'+s}
    function format2(n){return String(n).padStart(2,'0')}
    function nowDate(){const d=new Date();return d.toISOString().slice(0,10)}

    // ---------- State ----------
    let state = loadState();
    function loadState(){try{const raw=localStorage.getItem(STORAGE_KEY);if(raw){const parsed=JSON.parse(raw);parsed.betHistory=parsed.betHistory||[];return Object.assign({},DEFAULTS,parsed)} }catch(e){} const base=Object.assign({},DEFAULTS);base.playerID=randomId(6);saveState(base);return base}
    function saveState(s){localStorage.setItem(STORAGE_KEY,JSON.stringify(s))}

    // ---------- DOM refs ----------
    const slotsInput = [
      document.getElementById('slot1'),
      document.getElementById('slot2'),
      document.getElementById('slot3'),
      document.getElementById('slot4'),
      document.getElementById('slot5')
    ];
    const resultRow=document.getElementById('resultRow');
    const bet2=document.getElementById('bet2');
    const bet4=document.getElementById('bet4');
    const bet6=document.getElementById('bet6');
    const betAmount=document.getElementById('betAmount');
    const openBtn=document.getElementById('openBtn');
    const message=document.getElementById('message');
    const playerIdEl=document.getElementById('playerId');
    const playerPointsEl=document.getElementById('playerPoints');
    const shopPointsEl=document.getElementById('shopPoints');
    const historyList=document.getElementById('historyList');
    const depositBtn=document.getElementById('depositBtn');
    const resetBtn=document.getElementById('resetBtn');
    const welcomeModal=document.getElementById('welcomeModal');
    const closeWelcome=document.getElementById('closeWelcome');
    const rulesModal=document.getElementById('rulesModal');
    const rulesBtn=document.getElementById('rulesBtn');
    const closeRules=document.getElementById('closeRules');
    const winRateEl=document.getElementById('winRate');

    // shop refs
    const shopBtn=document.getElementById('shopBtn');
    const shopModal=document.getElementById('shopModal');
    const closeShop=document.getElementById('closeShop');
    const shopGrid=document.getElementById('shopGrid');
    const shopPointsInModal=document.getElementById('shopPointsInModal');
    const promptModal=document.getElementById('promptModal');
    const promptContent=document.getElementById('promptContent');
    const closePrompt=document.getElementById('closePrompt');
    const buy50kPoints = document.getElementById('buy50kPoints');

    // audio elements
    const spinSound = document.getElementById('spinSound');
    const winSound = document.getElementById('winSound');

    // ---------- Init UI ----------
    function updateUI(){
      playerIdEl.textContent=state.playerID;
      playerPointsEl.textContent=state.playerPoints.toLocaleString();
      shopPointsEl.textContent=state.shopPoints.toLocaleString();
      renderHistory();
      updateWinRate();
    }

    function updateModalShop(){
      shopPointsInModal.textContent=state.shopPoints.toLocaleString()
    }

    function updateWinRate(){
      const p2=(1/100);
      const p4=(1/10000);
      const p6=(1/1000000);
      winRateEl.textContent=`2s ${(p2*100).toFixed(2)}% · 4s ${(p4*100).toFixed(4)}% · 6s ${(p6*100).toFixed(6)}%`
    }

    function renderHistory(){
      historyList.innerHTML='';
      (state.betHistory||[]).slice().reverse().forEach(item=>{
        const el=document.createElement('div');
        el.className='history-item '+(item.win? 'win':'lose');
        const left = document.createElement('div');
        left.innerHTML=`<div style="font-weight:700">${item.win? '[Thắng]':'[Thua]'}</div><div class="muted">Cược ${Number(item.bet).toLocaleString()} (${item.type} số) — Dãy: ${item.playerSeq} — KQ: ${item.resultSeq}</div>`;
        const right = document.createElement('div');
        right.style.textAlign='right';
        if(item.win){
          right.innerHTML=`<div style="font-weight:700;color:var(--success);">+${Number(item.payout).toLocaleString()}</div><div class="muted">SP +${item.shopGain||0}</div>`
        }else{
          right.innerHTML=`<div class="muted">-${Number(item.bet).toLocaleString()}</div><div class="muted">SP +${item.shopGain||0}</div>`
        }
        el.appendChild(left);
        el.appendChild(right);
        historyList.appendChild(el)
      })
    }

    // ---------- Welcome ----------
    function firstVisitFlow(){
      if(!localStorage.getItem(STORAGE_KEY)){
        state.playerID=randomId(6);
        state.playerPoints=100000;
        state.shopPoints=0;
        state.betHistory=[];
        state.lastDepositDate=null;
        saveState(state)
      }
      welcomeModal.style.display='flex'
    }

    // ---------- Input helpers ----------
    slotsInput.forEach((el,i,array)=>{
      el.addEventListener('input',e=>{
        let v=el.value.replace(/[^0-9]/g,'').slice(0,2);
        el.value=v;
        if(v.length===2 && i<array.length-1) array[i+1].focus()
      });
      el.addEventListener('blur',e=>{
        if(el.value==='') el.value='00';
        else el.value=format2(Number(el.value))
      })
    })

    // ---------- Bet type ----------
    let currentBetType = 2;
    const betButtons=[bet2,bet4,bet6];
    function setBetType(t){
      currentBetType=t;
      betButtons.forEach(b=>{
        b.classList.remove('active');
        b.setAttribute('aria-checked','false');
        b.tabIndex = -1;
      });
      if(t===2){bet2.classList.add('active'); bet2.setAttribute('aria-checked','true'); bet2.tabIndex = 0;}
      if(t===4){bet4.classList.add('active'); bet4.setAttribute('aria-checked','true'); bet4.tabIndex = 0;}
      if(t===6){bet6.classList.add('active'); bet6.setAttribute('aria-checked','true'); bet6.tabIndex = 0;}
    }
    bet2.addEventListener('click',()=>setBetType(2));
    bet4.addEventListener('click',()=>setBetType(4));
    bet6.addEventListener('click',()=>setBetType(6));

    // keyboard navigation for bet types
    betButtons.forEach((btn,i)=>{
      btn.addEventListener('keydown', e=>{
        if(e.key==='ArrowRight' || e.key==='ArrowDown'){
          e.preventDefault();
          const next = betButtons[(i+1)%betButtons.length];
          next.focus();
          setBetType(Number(next.dataset.type));
        }
        if(e.key==='ArrowLeft' || e.key==='ArrowUp'){
          e.preventDefault();
          const prev = betButtons[(i-1+betButtons.length)%betButtons.length];
          prev.focus();
          setBetType(Number(prev.dataset.type));
        }
        if(e.key==='Enter' || e.key===' '){
          e.preventDefault();
          setBetType(Number(btn.dataset.type));
        }
      })
    })

    // ---------- Game logic ----------
    const multipliers = {2:3.75,4:6.75,6:15.95};
    let animating=false;

    openBtn.addEventListener('click',async ()=>{
      if(animating) return;

      // Validate inputs
      let values = slotsInput.map(el => el.value || '00');
      for(let v of values){
        if(!/^[0-9]{2}$/.test(v)){
          showMessage('Vui lòng nhập đủ 2 chữ số cho mỗi ô (00-99).',true);
          return;
        }
      }

      let bet = parseInt(betAmount.value.replace(/[^0-9]/g,''))||0;
      if(isNaN(bet)){
        showMessage('Cược không hợp lệ.',true);
        return;
      }
      if(bet < 10000){
        showMessage('Cược tối thiểu 10.000.',true);
        return;
      }
      if(bet > 100000){
        showMessage('Cược tối đa 100.000.',true);
        return;
      }
      if(bet > state.playerPoints){
        showMessage('Không đủ điểm để cược.',true);
        return;
      }

      // Deduct points
      state.playerPoints -= bet;
      saveState(state);
      updateUI();

      // UI lock
      animating=true;
      openBtn.disabled=true;
      openBtn.textContent='ĐANG XỔ SỐ...';
      openBtn.setAttribute('aria-busy', 'true');
      betAmount.disabled=true;
      betButtons.forEach(b=>b.style.pointerEvents='none');
      slotsInput.forEach(s=>s.disabled=true);
      showMessage('Đang quay số — chờ kết quả...', false);

      // Play spin sound
      spinSound.currentTime = 0;
      spinSound.play().catch(()=>{});

      // Animate
      const duration = 5200 + Math.floor(Math.random()*1800);
      const slots = resultRow.querySelectorAll('.result-slot');
      const randInt = ()=>{const arr=new Uint32Array(1);crypto.getRandomValues(arr);return arr[0]%100}
      const flipInterval = setInterval(()=>{
        slots.forEach(s=>{
          s.textContent=format2(randInt())
        })
      },70);
      await new Promise(res=>setTimeout(res,duration));
      clearInterval(flipInterval);

      // Final result
      const result = [randInt(),randInt(),randInt(),randInt(),randInt(),randInt()];
      slots.forEach((s,i)=>s.textContent=format2(result[i]));

      // Evaluate
      const playerSeq = values.join('');
      const resultSeq = result.map(n=>format2(n)).join('');
      let win=false;
      let payout=0;
      if(currentBetType===2){
        const player2 = playerSeq.slice(-2);
        const res2 = resultSeq.slice(-2);
        if(player2===res2){
          win=true;
          payout=Math.floor(bet * multipliers[2]);
        }
      }
      else if(currentBetType===4){
        const player4=playerSeq.slice(-4);
        const res4=resultSeq.slice(-4);
        if(player4===res4){
          win=true;
          payout=Math.floor(bet * multipliers[4]);
        }
      }
      else if(currentBetType===6){
        if(playerSeq===resultSeq){
          win=true;
          payout=Math.floor(bet * multipliers[6]);
        }
      }

      // ShopPoints gain for high bets
      let shopGain = 0;
      if(bet >= 50000){
        shopGain = 100 + Math.floor(Math.random()*401);
        state.shopPoints += shopGain;
      }

      if(win){
        state.playerPoints += payout;
        triggerWinEffects();
        showMessage('Bạn đã thắng! +'+payout.toLocaleString(),false);
        // Play win sound
        winSound.currentTime = 0;
        winSound.play().catch(()=>{});
      }else{
        triggerLoseEffects();
        showMessage('Bạn đã thua — chúc lượt sau may mắn hơn.',true);
      }

      // History
      const hist = {
        time:Date.now(),
        type:currentBetType,
        bet:bet,
        playerSeq:playerSeq,
        resultSeq:resultSeq,
        win:win,
        payout:win?payout:0,
        shopGain:shopGain
      };
      state.betHistory = state.betHistory || [];
      state.betHistory.push(hist);
      if(state.betHistory.length>50) state.betHistory.shift();
      saveState(state);

      // Unlock UI
      animating=false;
      openBtn.disabled=false;
      openBtn.textContent='MỞ THƯỞNG';
      openBtn.setAttribute('aria-busy', 'false');
      betAmount.disabled=false;
      betButtons.forEach(b=>b.style.pointerEvents='auto');
      slotsInput.forEach(s=>s.disabled=false);
      updateUI();
      if(shopGain>0){
        showMessage(`Bạn nhận thêm ${shopGain} ShopPoints (do cược ≥50k).`,false);
      }
    });

    function showMessage(txt,isError){
      message.textContent=txt;
      message.style.color=isError? '#ff6b6b':'#a6f0a6';
    }

    // ---------- Effects ----------
    function triggerWinEffects(){fireConfetti();}
    function triggerLoseEffects(){shakeElement(resultRow)}
    function shakeElement(el){
      el.animate([{transform:'translateY(0)'},{transform:'translateY(-6px)'},{transform:'translateY(0)'}],{duration:600,iterations:1})
    }

    // confetti
    const canvas = document.getElementById('confettiCanvas');
    const ctx = canvas.getContext('2d');
    let confettiParticles=[];
    function resizeCanvas(){
      canvas.width=window.innerWidth;
      canvas.height=window.innerHeight
    }
    window.addEventListener('resize',resizeCanvas);
    resizeCanvas();
    function fireConfetti(){
      const count=120;
      for(let i=0;i<count;i++){
        confettiParticles.push({
          x:Math.random()*canvas.width,
          y:-20,
          vy:2+Math.random()*6,
          vx:(Math.random()-0.5)*6,
          size:6+Math.random()*6,
          angle:Math.random()*360,
          spin:Math.random()*0.2+0.1,
          color:`hsl(${Math.floor(Math.random()*360)} 90% 60%)`,
          ttl:200+Math.random()*120
        })
      }
      startConfettiLoop()
    }
    let confettiLoop=null;
    function startConfettiLoop(){
      if(confettiLoop) return;
      confettiLoop=setInterval(()=>{
        ctx.clearRect(0,0,canvas.width,canvas.height);
        for(let i=confettiParticles.length-1;i>=0;i--){
          const p=confettiParticles[i];
          p.x+=p.vx;
          p.y+=p.vy;
          p.vy+=0.05;
          p.angle+=p.spin;
          p.ttl--;
          ctx.save();
          ctx.translate(p.x,p.y);
          ctx.rotate(p.angle);
          ctx.fillStyle=p.color;
          ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size);
          ctx.restore();
          if(p.y>canvas.height+30 || p.ttl<0){
            confettiParticles.splice(i,1)
          }
        }
        if(confettiParticles.length===0){
          clearInterval(confettiLoop);
          confettiLoop=null
        }
      },16)
    }

    // ---------- Deposit & Reset ----------
    depositBtn.addEventListener('click',()=>{
      const today = nowDate();
      if(state.lastDepositDate===today){
        alert('Bạn đã nạp điểm trong hôm nay rồi (1 lần/ngày).');
        return;
      }
      state.playerPoints += 100000;
      state.lastDepositDate = today;
      saveState(state);
      updateUI();
      showMessage('Nạp thành công +100.000 điểm',false)
    });
    resetBtn.addEventListener('click', ()=>{
      if(!confirm('Reset tài khoản về mặc định? Toàn bộ dữ liệu sẽ bị xóa khỏi localStorage.')) return;
      localStorage.removeItem(STORAGE_KEY);
      state = loadState();
      updateUI();
      showMessage('Tài khoản đã được reset.',false)
    })

    // ---------- Shop implementation ----------
    const SHOP_ITEMS = [
      {id:'p_cv',title:'Mẫu Prompt CV',desc:'Mẫu prompt CV chuyên nghiệp (mở ra để copy).',cost:300,type:'prompt'},
      {id:'skin_neon',title:'Skin Neon',desc:'Thay đổi giao diện sang skin Neon tạm thời.',cost:200,type:'skin'},
      {id:'pts50k',title:'Gói Điểm 50.000',desc:'Đổi lấy 50.000 Điểm chơi.',cost:500,type:'points',value:50000},
      {id:'avatar_1',title:'Khung Avatar Vàng',desc:'Khung avatar vàng trang trí profile (không lưu server).',cost:120,type:'cosmetic'}
    ];

    function renderShop(){
      shopGrid.innerHTML='';
      SHOP_ITEMS.forEach(it=>{
        const c=document.createElement('div');
        c.className='shop-card';
        c.innerHTML=`
          <div style="font-weight:800;margin-bottom:6px">${it.title}</div>
          <div class="muted" style="margin-bottom:10px">${it.desc}</div>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="muted">Giá: ${it.cost} SP</div>
            <button data-id="${it.id}" class="btn ghost" aria-label="Mua ${it.title}">${it.cost} SP</button>
          </div>`;
        shopGrid.appendChild(c)
      });
      shopGrid.querySelectorAll('button').forEach(b=>b.addEventListener('click',()=>{
        const id=b.dataset.id;
        buyItem(id)
      }))
    }

    function buyItem(id){
      const item = SHOP_ITEMS.find(x=>x.id===id);
      if(!item) return;
      if(state.shopPoints < item.cost){
        alert('Không đủ ShopPoints.');
        return;
      }
      if(!confirm(`Mua ${item.title} với giá ${item.cost} ShopPoints?`)) return;
      state.shopPoints -= item.cost;
      // give reward
      if(item.type==='points'){
        state.playerPoints += item.value;
        showMessage(`Mua thành công +${item.value.toLocaleString()} điểm.`,false)
      }
      else if(item.type==='prompt'){
        openPromptSample()
      }
      else if(item.type==='skin'){
        document.body.style.background='linear-gradient(180deg,#0b1228,#05102a)';
        showMessage('Skin Neon được áp dụng tạm thời.',false)
      }
      else if(item.type==='cosmetic'){
        showMessage('Khung avatar đã được mở khoá (mô phỏng).',false)
      }
      saveState(state);
      updateUI();
      updateModalShop();
      renderHistory();
    }

    function openPromptSample(){
      promptContent.textContent = `Tôi cần một CV chuyên nghiệp cho vị trí Thực tập sinh Kinh doanh bất động sản. Hãy cung cấp phần tóm tắt kỹ năng, học vấn, kinh nghiệm (nếu có), và các thành tựu phù hợp. Ngôn ngữ: Tiếng Việt.`;
      promptModal.style.display='flex'
    }

    buy50kPoints.addEventListener('click',()=>{
      if(state.shopPoints < 500){
        alert('Cần 500 ShopPoints để mua gói này.');
        return;
      }
      if(!confirm('Đổi 500 ShopPoints lấy 50.000 Điểm chơi?')) return;
      state.shopPoints -= 500;
      state.playerPoints += 50000;
      saveState(state);
      updateUI();
      updateModalShop();
      showMessage('Bạn đã đổi 50.000 điểm thành công.',false)
    })

    shopBtn.addEventListener('click',()=>{
      renderShop();
      updateModalShop();
      shopModal.style.display='flex'
    })
    closeShop.addEventListener('click',()=>{shopModal.style.display='none'})
    closePrompt.addEventListener('click',()=>{promptModal.style.display='none'})

    // ---------- Other buttons ----------
    document.getElementById('otherGame1').addEventListener('click',()=>{location.href='index.html'});
    document.getElementById('otherGame2').addEventListener('click',()=>{location.href='xucsac.html'})

    // ---------- Modals ----------
    closeWelcome.addEventListener('click',()=>{
      welcomeModal.style.display='none';
      updateUI()
    });
    rulesBtn.addEventListener('click',()=>{rulesModal.style.display='flex'});
    closeRules.addEventListener('click',()=>{rulesModal.style.display='none'})

    // ---------- On load ----------
    setBetType(2);
    updateUI();
    firstVisitFlow();
    window.addEventListener('beforeunload',()=>saveState(state));
  </script>
</body>
</html>