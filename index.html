<html lang="vi">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width,initial-scale=1" name="viewport"/>
  <title>
   Ch·∫≥n L·∫ª - Shop game Dopi
  </title>
  <script src="https://cdn.tailwindcss.com">
  </script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <style>
   :root {
      --bg: #0f1724;
      --card: #111827;
      --accent: #06b6d4;
      --accent-light: #7dd3fc;
      --muted: #94a3b8;
      --success: #16a34a;
      --danger: #ef4444;
    }
    * {
      box-sizing: border-box;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: linear-gradient(160deg, #0f1724, #1e293b);
      color: #fafafa;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    body {
      min-height: 100vh;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 24px;
    }
    .container {
      width: 100%;
      max-width: 1100px;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    header h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 600;
      color: var(--accent);
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 20px;
    }
    @media (max-width: 980px) {
      .grid {
        grid-template-columns: 1fr;
      }
      .container {
        padding: 12px;
      }
    }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border-radius: 14px;
      padding: 20px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.5);
      backdrop-filter: blur(6px);
    }
    label {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.04);
      color: #fafafa;
      font-size: 14px;
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg fill='none' stroke='%23fafafa' stroke-width='2' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3e%3cpath stroke-linecap='round' stroke-linejoin='round' d='M19 9l-7 7-7-7'%3e%3c/path%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 1em;
      cursor: pointer;
    }
    select option {
      background: var(--card);
      color: #fafafa;
    }
    select:focus, select:active {
      outline: none;
      background: rgba(255,255,255,0.1);
      color: #fafafa;
    }
    input[type="number"] {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.04);
      color: inherit;
      font-size: 14px;
      -moz-appearanc: textfield;
    }
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }
    button, .btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.15);
      padding: 10px 14px;
      border-radius: 10px;
      color: inherit;
      cursor: pointer;
      transition: all 0.25s ease;
      user-select: none;
    }
    button:hover, .btn:hover {
      background: rgba(255,255,255,0.08);
    }
    .btn.primary {
      background: linear-gradient(90deg, var(--accent), var(--accent-light));
      color: #022;
      font-weight: 600;
      box-shadow: 0 6px 14px rgba(6,182,212,0.25);
      border: 0;
    }
    .btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 18px rgba(6,182,212,0.35);
    }
    .play-row {
      display: flex;
      gap: 12px;
      margin-top: 10px;
    }
    .play-row button {
      flex: 1;
      font-weight: 600;
      border-color: rgba(255,255,255,0.15);
      transition: border-color 0.3s ease;
    }
    .play-row button.selected {
      border-color: var(--accent);
      background: rgba(6,182,212,0.15);
    }
    .result-box {
      margin-top: 16px;
      padding: 14px;
      border-radius: 10px;
      background: rgba(255,255,255,0.05);
      text-align: center;
      min-height: 110px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 6px;
    }
    .draw-number {
      font-size: 52px;
      font-weight: 700;
      color: #facc15;
      user-select: none;
    }
    .account {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .small {
      font-size: 13px;
      color: var(--muted);
    }
    .balance {
      font-size: 26px;
      font-weight: 700;
      color: var(--accent-light);
    }
    .history {
      max-height: 300px;
      overflow: auto;
      padding: 8px;
      border-radius: 8px;
      background: rgba(255,255,255,0.04);
    }
    .history table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .history td, .history th {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      user-select: text;
    }
    .history tr.win td {
      color: var(--success);
      font-weight: 600;
    }
    .history tr.lose td {
      color: var(--danger);
      font-weight: 600;
    }
    footer {
      margin-top: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: var(--muted);
      user-select: none;
    }
    .banner {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      top: 18px;
      min-width: 280px;
      max-width: 80%;
      padding: 14px 18px;
      border-radius: 10px;
      background: rgba(2,6,23,0.95);
      display: none;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      box-shadow: 0 6px 20px rgba(2,6,23,0.6);
      animation: fadeInDown 0.5s ease;
      user-select: none;
      color: #fafafa;
      z-index: 99999;
    }
    .banner.show {
      display: flex;
    }
    .banner.success {
      border-left: 6px solid var(--success);
    }
    .banner.error {
      border-left: 6px solid var(--danger);
    }
    @keyframes fadeInDown {
      from { opacity: 0; transform: translate(-50%, -20px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }
    .contact {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .tg {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      text-decoration: none;
      color: inherit;
      font-size: 14px;
      user-select: none;
    }
    .tg:hover {
      background: rgba(255,255,255,0.08);
    }
    .tg svg {
      width: 18px;
      height: 18px;
    }
    .win-text {
      border: 2px solid var(--success);
      color: var(--success);
      font-weight: 700;
      padding: 6px 12px;
      border-radius: 10px;
      user-select: none;
    }
    .lose-text {
      border: 2px solid var(--danger);
      color: var(--danger);
      font-weight: 700;
      padding: 6px 12px;
      border-radius: 10px;
      user-select: none;
    }
    /* Announcement modal */
    .announcement {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .announcement-content {
      background: #2d577c;
      padding: 20px 25px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      position: relative;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      animation: fadeIn 0.4s ease;
      color: #fafafa;
      user-select: none;
    }
    .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 22px;
      font-weight: bold;
      color: #090909;
      cursor: pointer;
      user-select: none;
    }
    @keyframes fadeIn {
      from {opacity: 0; transform: scale(0.9);}
      to {opacity: 1; transform: scale(1);}
    }
  </style>
 </head>
 <body>
  <!-- Banner th√¥ng b√°o -->
  <div aria-describedby="announcement-desc" aria-labelledby="announcement-title" aria-modal="true" class="announcement" id="announcement" role="dialog">
   <div class="announcement-content">
    <span aria-label="ƒê√≥ng th√¥ng b√°o" class="close-btn" onclick="closeAnnouncement()">
     √ó
    </span>
    <h2 id="announcement-title">
     üì¢ Th√¥ng b√°o quan tr·ªçng
    </h2>
    <p id="announcement-desc" style="color:red; font-weight:bold; margin-top:10px;">
     ‚ö†Ô∏è ƒê√¢y ch·ªâ l√† tr√≤ ch∆°i do team l√†m ra ƒë·ªÉ x·∫£ stress.  
        Kh√¥ng nh·∫≠n ti·ªÅn ƒë·ªÉ n·∫°p ƒëi·ªÉm v√† kh√¥ng r√∫t ƒëi·ªÉm.  
        Tuy·ªát ƒë·ªëi kh√¥ng li√™n quan ƒë·∫øn c·ªù b·∫°c d∆∞·ªõi m·ªçi h√¨nh th·ª©c!
    </p>
   </div>
  </div>
  <div class="container" role="main">
   <header>
    <h1>
     Shop game Dopi
    </h1>
    <div aria-label="Li√™n h·ªá Telegram" class="contact small">
     <div class="tg" title="Li√™n h·ªá Telegram">
      <a aria-label="Li√™n h·ªá Telegram @tomxinh917" href="https://t.me/tomxinh917" id="tg-link" rel="noopener noreferrer" style="color:inherit;text-decoration:none;display:flex;align-items:center;gap:8px" target="_blank">
       <svg aria-hidden="true" fill="none" height="18" viewBox="0 0 240 240" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M120 0C53.73 0 0 53.73 0 120s53.73 120 120 120 120-53.73 120-120S186.27 0 120 0z" fill="#06A7D9"/><path d="M45.6 119.4l33.9 12.9 14.8 46.9c1.2 3.8 3.4 4.8 6.9 3 6.5-3.6 51.3-37.8 68.5-50.6 3-2.2 5.4-4.9 2.6-8.2-2.2-2.7-7.2-1-10-0.1L56.2 86.2c-5.9-2.5-5.9 1.8-9.2 5.2-3.1 3.1-5.2 7.1-1.4 13z" fill="#fff"/></svg>
       <span>
        @tomxinh917
       </span>
      </a>
     </div>
    </div>
   </header>
   <div class="grid">
    <div aria-label="Khu v·ª±c tr√≤ ch∆°i" class="card">
     <h2 class="text-xl font-semibold mb-2">
     <h2 style="margin-top:0">Tr√≤ ch∆°i</h2>
<p class="small mb-4">
  Quy t·∫Øc: R√∫t 1 s·ªë ng·∫´u nhi√™n t·ª´ 0‚Äì9. Ng∆∞·ªùi ch∆°i c√≥ th·ªÉ ƒë·∫∑t c∆∞·ª£c theo 
  <strong>Ch·∫µn / L·∫ª</strong> ho·∫∑c <strong>Theo s·ªë</strong>.<br/>
  - Ch·ªçn <strong>Ch·∫µn / L·∫ª</strong>: N·∫øu k·∫øt qu·∫£ tr√πng v·ªõi l·ª±a ch·ªçn, th·∫Øng tr·∫£ x1.75 l·∫ßn c∆∞·ª£c.<br/>
  - Ch·ªçn <strong>Theo s·ªë</strong>: N·∫øu k·∫øt qu·∫£ tr√πng v·ªõi s·ªë ƒë√£ ch·ªçn, th·∫Øng tr·∫£ x2.55 l·∫ßn c∆∞·ª£c.<br/>
  - M·ªói l∆∞·ª£t c∆∞·ª£c t·ª´ 10.000 ƒë·∫øn 100.000 ƒëi·ªÉm.<br/>
  - K·∫øt qu·∫£ ho√†n to√†n ng·∫´u nhi√™n, kh√¥ng c√≥ c√°ch n√†o ƒë·∫£m b·∫£o th·∫Øng.<br/><br/>
  L∆∞u √Ω: Tr√≤ ch∆°i ch·ªâ mang t√≠nh gi·∫£i tr√≠, x·∫£ stress. ƒêi·ªÉm trong tr√≤ ch∆°i kh√¥ng th·ªÉ ƒë·ªïi th√†nh ti·ªÅn th·∫≠t. Kh√¥ng khuy·∫øn kh√≠ch c·ªù b·∫°c hay ƒë√°nh b·∫°c th·∫≠t. H√£y ch∆°i v·ª´a ph·∫£i, ki·ªÉm so√°t ƒëi·ªÉm v√† t√¢m l√Ω ƒë·ªÉ tr·∫£i nghi·ªám vui v·∫ª v√† an to√†n.
  N·∫øu c√≥ ƒë·ªÅ xu·∫•t ho·∫∑c th·∫Øc m·∫Øc, li√™n h·ªá Telegram ·ªü tr√™n.
</p>

     <form aria-label="Form ƒë·∫∑t c∆∞·ª£c" class="flex flex-wrap gap-4 mb-3" id="game-form" onsubmit="return false;">
      <div class="flex-1 min-w-[180px]">
       <label class="block mb-1 text-sm text-gray-400" for="bet-mode">
        Ch·ªçn ki·ªÉu ƒë·∫∑t
       </label>
       <select aria-describedby="bet-mode-desc" aria-required="true" class="w-full px-3 py-3 rounded-lg bg-[rgba(255,255,255,0.04)] border border-[rgba(255,255,255,0.1)] text-white text-sm appearance-none cursor-pointer" id="bet-mode" name="bet-mode">
        <option value="parity">
         Ch·∫µn / L·∫ª (x1.75)
        </option>
        <option value="number">
         Theo s·ªë (x2.55)
        </option>
       </select>
       <p class="sr-only" id="bet-mode-desc">
        Ch·ªçn ki·ªÉu ƒë·∫∑t c∆∞·ª£c: Ch·∫µn/L·∫ª ho·∫∑c Theo s·ªë
       </p>
      </div>
      <div class="w-[140px]">
       <label class="block mb-1 text-sm text-gray-400" for="bet-amount">
        S·ªë ti·ªÅn c∆∞·ª£c (ƒëi·ªÉm)
       </label>
       <input aria-label="S·ªë ti·ªÅn c∆∞·ª£c" aria-required="true" class="w-full px-3 py-3 rounded-lg bg-[rgba(255,255,255,0.04)] border border-[rgba(255,255,255,0.1)] text-white text-sm" id="bet-amount" max="100000" min="10000" name="bet-amount" step="1000" type="number" value="10000"/>
      </div>
      <div class="w-[120px] hidden" id="number-picker-wrap">
       <label class="block mb-1 text-sm text-gray-400" for="bet-number">
        Ch·ªçn s·ªë (0‚Äì9)
       </label>
       <input aria-label="Ch·ªçn s·ªë t·ª´ 0 ƒë·∫øn 9" class="w-full px-3 py-3 rounded-lg bg-[rgba(255,255,255,0.04)] border border-[rgba(255,255,255,0.1)] text-white text-sm" id="bet-number" max="9" min="0" name="bet-number" type="number" value="0"/>
      </div>
      <fieldset aria-label="Ch·ªçn Ch·∫µn ho·∫∑c L·∫ª" aria-required="true" class="w-[140px]">
       <legend class="block mb-1 text-sm text-gray-400">
        Ch·ªçn
       </legend>
       <div class="play-row">
        <button aria-label="Ch·ªçn Ch·∫µn" aria-pressed="false" class="btn" id="choose-even" type="button">
         Ch·∫µn
        </button>
        <button aria-label="Ch·ªçn L·∫ª" aria-pressed="false" class="btn" id="choose-odd" type="button">
         L·∫ª
        </button>
       </div>
      </fieldset>
     </form>
     <div class="flex flex-wrap gap-3 items-center mb-3">
      <button aria-label="Ch∆°i" class="btn primary" id="play-btn">
       Ch∆°i
      </button>
      <button aria-label="TƒÉng c∆∞·ª£c th√™m 10.000 ƒëi·ªÉm" class="btn" id="quick-10">
       +10k
      </button>
      <button aria-label="TƒÉng c∆∞·ª£c th√™m 50.000 ƒëi·ªÉm" class="btn" id="quick-50">
       +50k
      </button>
      <button aria-label="ƒê·∫∑t c∆∞·ª£c t·ªëi ƒëa 100.000 ƒëi·ªÉm" class="btn" id="quick-max">
       Max
      </button>
      <button aria-label="Ch∆°i t·ª± ƒë·ªông 5 l·∫ßn" class="btn" id="auto-play-btn">
       Auto x5
      </button>
     </div>
     <div aria-atomic="true" aria-label="K·∫øt qu·∫£ tr√≤ ch∆°i" aria-live="polite" class="result-box" id="result-box" role="region">
      <div class="small" id="status">
       S·∫µn s√†ng ch∆°i ‚Äî ch√∫c b·∫°n may m·∫Øn!
      </div>
      <div aria-atomic="true" aria-label="S·ªë ƒë∆∞·ª£c r√∫t" aria-live="polite" class="draw-number" id="draw-number">
       -
      </div>
      <div class="mt-1" id="payout-info">
      </div>
     </div>
    </div>
    <div aria-label="Th√¥ng tin t√†i kho·∫£n v√† l·ªãch s·ª≠" class="account">
     <div class="card p-3">
      <div class="flex justify-between items-center">
       <div>
        <div class="small">
         ID ng∆∞·ªùi ch∆°i
        </div>
        <div class="small font-bold select-text" id="player-id">
        </div>
       </div>
       <div class="text-right">
        <div class="small">
         S·ªë d∆∞
        </div>
        <div class="balance select-text" id="balance">
         0 ƒëi·ªÉm
        </div>
       </div>
      </div>
      <div class="mt-3 flex flex-wrap gap-2 items-center">
       <input aria-label="S·ªë ƒëi·ªÉm n·∫°p" class="flex-grow px-3 py-3 rounded-lg bg-[rgba(255,255,255,0.04)] border border-[rgba(255,255,255,0.1)] text-white text-sm" id="topup-amount" max="100000" min="10000" placeholder="S·ªë ƒëi·ªÉm n·∫°p" step="10000" type="number"/>
       <button aria-label="N·∫°p ƒëi·ªÉm" class="btn" id="topup-btn">
        N·∫°p ƒëi·ªÉm
       </button>
      </div>
      <div aria-live="assertive" class="mt-2 text-sm text-yellow-400 hidden" id="topup-limit-msg" role="alert">
      </div>
     </div>
     <div class="small mt-2">
      L·ªãch s·ª≠ ƒë·∫∑t (m·ªõi nh·∫•t ·ªü tr√™n)
     </div>
     <div aria-label="L·ªãch s·ª≠ ƒë·∫∑t c∆∞·ª£c" class="history" id="history" tabindex="0">
      <table class="w-full text-left" id="history-table">
       <thead>
        <tr>
         <th class="px-2 py-1">
          Th·ªùi gian
         </th>
         <th class="px-2 py-1">
          Lo·∫°i
         </th>
         <th class="px-2 py-1">
          C∆∞·ª£c
         </th>
         <th class="px-2 py-1">
          KQ
         </th>
         <th class="px-2 py-1">
          Thay ƒë·ªïi
         </th>
        </tr>
       </thead>
       <tbody>
       </tbody>
      </table>
     </div>
     <div class="card mt-3 p-3" id="stats">
      <div class="small">
       Th·ªëng k√™: T·ªïng v√°n:
       <span id="totalGames">
        0
       </span>
       | Th·∫Øng:
       <span id="winCount">
        0
       </span>
       | T·ª∑ l·ªá th·∫Øng:
       <span id="winRate">
        0%
       </span>
      </div>
     </div>
     <div class="card p-3 mt-3">
      <h3 class="mb-2 text-lg font-semibold">
       T√πy ch·ªçn v√† th√¥ng tin
      </h3>
      <p class="small">
       Gi·ªõi h·∫°n c∆∞·ª£c:
       <strong>
        10.000
       </strong>
       ‚Äî
       <strong>
        100.000
       </strong>
       ƒëi·ªÉm.
       <br/>
       Payout ch·∫µn/l·∫ª: x1.75 | Theo s·ªë: x2.55
      </p>
      <div class="mt-2 flex gap-2 flex-wrap">
       <button aria-label="Reset t√†i kho·∫£n" class="btn" id="reset-btn">
        Reset t√†i kho·∫£n
       </button>
       <button aria-label="Xu·∫•t l·ªãch s·ª≠" class="btn" id="export-btn">
        Xu·∫•t L·ªãch s·ª≠
       </button>
      </div>
     </div>
     <footer aria-label="Th√¥ng tin b·∫£n quy·ªÅn v√† phi√™n b·∫£n" class="mt-3 flex justify-between text-xs text-gray-400 select-none">
      <div>
       ¬© Shop game Dopi
      </div>
      <div>
       Phi√™n b·∫£n demo 1.0
      </div>
     </footer>
    </div>
   </div>
  </div>
  <div aria-atomic="true" aria-live="assertive" class="banner" id="banner" role="alert">
   <div id="banner-text">
   </div>
   <div aria-label="ƒê√≥ng th√¥ng b√°o" id="banner-close" role="button" style="margin-left:auto;cursor:pointer" tabindex="0">
    ‚úñ
   </div>
  </div>
  <script>
   function closeAnnouncement() {
      document.getElementById("announcement").style.display = "none";
    }

    // --- App state persisted in localStorage ---
    const MIN_BET = 10000, MAX_BET = 100000;
    const STORAGE_KEY = 'dopi_game_v1';
    const STORAGE_TOPUP_KEY = 'dopi_game_topup_v1';

    function uid(len=8){return Math.random().toString(36).slice(2,2+len).toUpperCase()}

    let state = {
      playerId: null,
      balance: 100000, // default starting balance
      history: []
    };

    // Track daily topup amount and date
    let topupState = {
      date: null,
      amountToday: 0
    };

    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){Object.assign(state, JSON.parse(raw));}
      }catch(e){console.warn(e);}
      if(!state.playerId) state.playerId = 'P-'+uid(6);

      try {
        const rawTopup = localStorage.getItem(STORAGE_TOPUP_KEY);
        if(rawTopup) {
          const parsed = JSON.parse(rawTopup);
          if(parsed.date === getTodayDate()) {
            topupState = parsed;
          } else {
            topupState = {date: getTodayDate(), amountToday: 0};
            localStorage.setItem(STORAGE_TOPUP_KEY, JSON.stringify(topupState));
          }
        } else {
          topupState = {date: getTodayDate(), amountToday: 0};
          localStorage.setItem(STORAGE_TOPUP_KEY, JSON.stringify(topupState));
        }
      } catch(e) {
        console.warn(e);
      }
      save();
    }
    function save(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      localStorage.setItem(STORAGE_TOPUP_KEY, JSON.stringify(topupState));
    }

    // UI refs
    const playerIdEl = document.getElementById('player-id');
    const balanceEl = document.getElementById('balance');
    const historyBody = document.querySelector('#history-table tbody');
    const betMode = document.getElementById('bet-mode');
    const betAmount = document.getElementById('bet-amount');
    const betNumber = document.getElementById('bet-number');
    const numberPickerWrap = document.getElementById('number-picker-wrap');
    const chooseEven = document.getElementById('choose-even');
    const chooseOdd = document.getElementById('choose-odd');
    const playBtn = document.getElementById('play-btn');
    const resultBox = document.getElementById('result-box');
    const statusEl = document.getElementById('status');
    const drawNumberEl = document.getElementById('draw-number');
    const payoutInfo = document.getElementById('payout-info');
    const topupBtn = document.getElementById('topup-btn');
    const topupAmount = document.getElementById('topup-amount');
    const resetBtn = document.getElementById('reset-btn');
    const exportBtn = document.getElementById('export-btn');
    const banner = document.getElementById('banner');
    const bannerText = document.getElementById('banner-text');
    const bannerClose = document.getElementById('banner-close');
    const topupLimitMsg = document.getElementById('topup-limit-msg');
    const autoPlayBtn = document.getElementById('auto-play-btn');

    let lastChoice = null; // 'even' or 'odd' -> for parity bets
    let autoPlayCount = 0;
    let autoPlayRunning = false;
    let autoPlayChoice = null; // store choice for auto play

    // Audio setup
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();

    // Play spinning sound (loop)
    let spinOscillator = null;
    let spinGain = null;

    function playSpinSound() {
      if (spinOscillator) return; // already playing
      spinOscillator = audioContext.createOscillator();
      spinGain = audioContext.createGain();
      spinOscillator.type = 'triangle';
      spinOscillator.frequency.setValueAtTime(440, audioContext.currentTime);
      spinGain.gain.setValueAtTime(0.05, audioContext.currentTime);
      spinOscillator.connect(spinGain);
      spinGain.connect(audioContext.destination);
      spinOscillator.start();
      // frequency modulation for spinning effect
      let freq = 440;
      let direction = 1;
      const interval = setInterval(() => {
        if (!spinOscillator) {
          clearInterval(interval);
          return;
        }
        freq += direction * 20;
        if (freq > 660) direction = -1;
        if (freq < 440) direction = 1;
        spinOscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
      }, 100);
      spinOscillator._interval = interval;
    }
    function stopSpinSound() {
      if (spinOscillator) {
        clearInterval(spinOscillator._interval);
        spinOscillator.stop();
        spinOscillator.disconnect();
        spinGain.disconnect();
        spinOscillator = null;
        spinGain = null;
      }
    }

    // Play win sound
    function playWinSound() {
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(880, audioContext.currentTime);
      gain.gain.setValueAtTime(0.15, audioContext.currentTime);
      osc.connect(gain);
      gain.connect(audioContext.destination);
      osc.start();
      osc.frequency.exponentialRampToValueAtTime(1760, audioContext.currentTime + 0.3);
      gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);
      osc.stop(audioContext.currentTime + 0.3);
    }

    // Play lose sound
    function playLoseSound() {
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(220, audioContext.currentTime);
      gain.gain.setValueAtTime(0.15, audioContext.currentTime);
      osc.connect(gain);
      gain.connect(audioContext.destination);
      osc.start();
      osc.frequency.exponentialRampToValueAtTime(110, audioContext.currentTime + 0.4);
      gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.4);
      osc.stop(audioContext.currentTime + 0.4);
    }

    // Utility: get today's date string YYYY-MM-DD
    function getTodayDate() {
      const d = new Date();
      return d.toISOString().slice(0,10);
    }

    // render UI from state 
    function render(){
      playerIdEl.textContent = state.playerId;
      balanceEl.textContent = state.balance.toLocaleString('vi-VN');
      // history
      historyBody.innerHTML = '';
      for(const h of [...state.history].reverse()){
        const tr = document.createElement('tr');
        tr.className = h.delta > 0 ? 'win' : 'lose';
        tr.innerHTML = `<td class="px-2 py-1">${new Date(h.t).toLocaleString()}</td><td class="px-2 py-1">${h.mode}</td><td class="px-2 py-1">${h.bet.toLocaleString()}</td><td class="px-2 py-1">${h.choice}</td><td class="px-2 py-1">${h.delta>0?'+':''}${h.delta.toLocaleString()}</td>`;
        historyBody.appendChild(tr);
      }
      // Update topup limit message
      if(topupState.amountToday >= 100000) {
        topupLimitMsg.textContent = 'B·∫°n ƒë√£ ƒë·∫°t gi·ªõi h·∫°n n·∫°p ƒëi·ªÉm trong ng√†y (100.000 ƒëi·ªÉm). Vui l√≤ng quay l·∫°i v√†o ng√†y mai.';
        topupLimitMsg.classList.remove('hidden');
      } else {
        topupLimitMsg.textContent = '';
        topupLimitMsg.classList.add('hidden');
      }
    }
    function pushHistory(item){
      state.history.push(item);
      if(state.history.length>200) state.history.shift();
      save();
      render();
    }

    // UI interactions
    betMode.addEventListener('change', e => {
      if (betMode.value === 'number') {
        numberPickerWrap.classList.remove('hidden');
        chooseEven.classList.remove('selected');
        chooseOdd.classList.remove('selected');
        chooseEven.setAttribute('aria-pressed', 'false');
        chooseOdd.setAttribute('aria-pressed', 'false');
        lastChoice = null;
      } else {
        numberPickerWrap.classList.add('hidden');
        betNumber.value = '0';
      }
    });

    function selectChoice(choice) {
      if (lastChoice === choice) {
        // toggle off
        lastChoice = null;
        chooseEven.classList.remove('selected');
        chooseOdd.classList.remove('selected');
        chooseEven.setAttribute('aria-pressed', 'false');
        chooseOdd.setAttribute('aria-pressed', 'false');
      } else {
        lastChoice = choice;
        if (choice === 'even') {
          chooseEven.classList.add('selected');
          chooseOdd.classList.remove('selected');
          chooseEven.setAttribute('aria-pressed', 'true');
          chooseOdd.setAttribute('aria-pressed', 'false');
        } else {
          chooseOdd.classList.add('selected');
          chooseEven.classList.remove('selected');
          chooseOdd.setAttribute('aria-pressed', 'true');
          chooseEven.setAttribute('aria-pressed', 'false');
        }
      }
    }

    chooseEven.addEventListener('click', () => selectChoice('even'));
    chooseOdd.addEventListener('click', () => selectChoice('odd'));

    document.getElementById('quick-10').addEventListener('click', () => {
      betAmount.value = clamp(Number(betAmount.value||0)+10000,MIN_BET,MAX_BET);
    });
    document.getElementById('quick-50').addEventListener('click', () => {
      betAmount.value = clamp(Number(betAmount.value||0)+50000,MIN_BET,MAX_BET);
    });
    document.getElementById('quick-max').addEventListener('click', () => {
      betAmount.value = MAX_BET;
    });

    playBtn.addEventListener('click', () => {
      if(autoPlayRunning) return; // prevent manual play during auto
      playRound();
    });

    topupBtn.addEventListener('click', () => {
      const a = Number(topupAmount.value||0);
      if(!a || a<10000){
        showBanner('S·ªë ƒëi·ªÉm n·∫°p t·ªëi thi·ªÉu 10.000','error');
        return;
      }
      if(a > 100000){
        showBanner('S·ªë ƒëi·ªÉm n·∫°p t·ªëi ƒëa 100.000','error');
        return;
      }
      if(topupState.amountToday + a > 100000){
        showBanner('B·∫°n ƒë√£ ƒë·∫°t gi·ªõi h·∫°n n·∫°p ƒëi·ªÉm trong ng√†y (100.000 ƒëi·ªÉm). Vui l√≤ng quay l·∫°i v√†o ng√†y mai.','error');
        return;
      }
      // add to balance and save  
      state.balance += a;
      topupState.amountToday += a;
      save();
      render();
      showBanner('N·∫°p ƒëi·ªÉm th√†nh c√¥ng: +' + a.toLocaleString(),'success');
      topupAmount.value = '';
    });

    resetBtn.addEventListener('click', () => {
      if(!confirm('X√°c nh·∫≠n reset t√†i kho·∫£n v√† l·ªãch s·ª≠?')) return;
      state = {playerId:'P-'+uid(6),balance:100000,history:[]};
      topupState = {date: getTodayDate(), amountToday: 0};
      save();
      render();
      showBanner('ƒê√£ reset t√†i kho·∫£n','success');
    });

    exportBtn.addEventListener('click', () => {
      const csv = ['Th·ªùi gian,Lo·∫°i,C∆∞·ª£c,Ch·ªçn,K·∫øt qu·∫£,Thay ƒë·ªïi'];
      for(const h of state.history){
        csv.push([new Date(h.t).toLocaleString(),h.mode,h.bet,h.choice,h.result,h.delta].map(s=>`"${String(s).replace(/"/g,'""')}"`).join(','));
      }
      const blob = new Blob([csv.join('\n')],{type:'text/csv;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='history.csv'; a.click(); URL.revokeObjectURL(url);
    });

    bannerClose.addEventListener('click', () => {
      banner.classList.remove('show');
    });
    bannerClose.addEventListener('keydown', e => {
      if(e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        banner.classList.remove('show');
      }
    });

    function clamp(v,min,max){return Math.max(min,Math.min(max,v));}

    // Auto play x5 feature
    autoPlayBtn.addEventListener('click', () => {
      if(autoPlayRunning) {
        // Stop auto play
        autoPlayRunning = false;
        autoPlayCount = 0;
        autoPlayChoice = null;
        autoPlayBtn.textContent = 'Auto x5';
        playBtn.disabled = false;
        showBanner('ƒê√£ d·ª´ng ch∆°i t·ª± ƒë·ªông', 'error');
      } else {
        // Start auto play
        if(autoPlayCount > 0) return; // already running

        // Determine and set choice for auto play
        if(betMode.value === 'parity'){
          if(!lastChoice){
            showBanner('Vui l√≤ng ch·ªçn Ch·∫µn ho·∫∑c L·∫ª tr∆∞·ªõc khi ch∆°i t·ª± ƒë·ªông','error');
            return;
          }
          autoPlayChoice = lastChoice; // 'even' or 'odd'
        } else if(betMode.value === 'number'){
          const chosen = Number(betNumber.value);
          if(isNaN(chosen) || chosen < 0 || chosen > 9){
            showBanner('Vui l√≤ng ch·ªçn s·ªë t·ª´ 0 ƒë·∫øn 9 tr∆∞·ªõc khi ch∆°i t·ª± ƒë·ªông','error');
            return;
          }
          autoPlayChoice = chosen; // number 0-9
        } else {
          showBanner('Ki·ªÉu ƒë·∫∑t kh√¥ng h·ª£p l·ªá','error');
          return;
        }

        autoPlayCount = 5;
        autoPlayRunning = true;
        autoPlayBtn.textContent = 'ƒêang Auto...';
        playBtn.disabled = true;

        // Set UI to reflect autoPlayChoice
        if(betMode.value === 'parity'){
          if(autoPlayChoice === 'even'){
            selectChoice('even');
          } else {
            selectChoice('odd');
          }
        } else {
          betNumber.value = autoPlayChoice;
        }

        runAutoPlay();
      }
    });

    function runAutoPlay() {
      if(autoPlayCount <= 0 || !autoPlayRunning) {
        autoPlayRunning = false;
        autoPlayChoice = null;
        autoPlayBtn.textContent = 'Auto x5';
        playBtn.disabled = false;
        return;
      }
      // Check if enough balance
      const bet = Math.floor(Number(betAmount.value)||0);
      if(bet > state.balance) {
        showBanner('Kh√¥ng ƒë·ªß ƒëi·ªÉm ƒë·ªÉ c∆∞·ª£c cho Auto Play', 'error');
        autoPlayRunning = false;
        autoPlayChoice = null;
        autoPlayBtn.textContent = 'Auto x5';
        playBtn.disabled = false;
        return;
      }
      playRound(true);
    }

    // Play round, param auto to indicate if called from auto play
    function playRound(auto=false){
      const mode = betMode.value;
      const bet = Math.floor(Number(betAmount.value)||0);
      if(!bet || bet < MIN_BET || bet > MAX_BET){
        showBanner(`C∆∞·ª£c ph·∫£i n·∫±m trong ${MIN_BET.toLocaleString()} - ${MAX_BET.toLocaleString()} ƒëi·ªÉm`,'error');
        if(auto) stopAutoPlay();
        return;
      }
      if(bet > state.balance){
        showBanner('Kh√¥ng ƒë·ªß ƒëi·ªÉm ƒë·ªÉ c∆∞·ª£c','error');
        if(auto) stopAutoPlay();
        return;
      }

      if(mode === 'parity'){
        if(auto && autoPlayChoice){
          lastChoice = autoPlayChoice;
          if(lastChoice === 'even'){
            chooseEven.classList.add('selected');
            chooseOdd.classList.remove('selected');
            chooseEven.setAttribute('aria-pressed', 'true');
            chooseOdd.setAttribute('aria-pressed', 'false');
          } else {
            chooseOdd.classList.add('selected');
            chooseEven.classList.remove('selected');
            chooseOdd.setAttribute('aria-pressed', 'true');
            chooseEven.setAttribute('aria-pressed', 'false');
          }
        }
        if(!lastChoice){
          showBanner('Vui l√≤ng ch·ªçn Ch·∫µn ho·∫∑c L·∫ª tr∆∞·ªõc khi ch∆°i','error');
          if(auto) stopAutoPlay();
          return;
        }
      }
      if(mode === 'number'){
        if(auto && autoPlayChoice !== null && autoPlayChoice !== undefined){
          betNumber.value = autoPlayChoice;
        }
        const chosen = Number(betNumber.value);
        if(isNaN(chosen) || chosen<0 || chosen>9){
          showBanner('Ch·ªçn s·ªë t·ª´ 0 ƒë·∫øn 9','error');
          if(auto) stopAutoPlay();
          return;
        }
      }

      // deduct temporarily
      state.balance -= bet;
      save();
      render();

      statusEl.textContent = 'ƒêang quay s·ªë ng·∫´u nhi√™n...';
      drawNumberEl.textContent = '-';
      payoutInfo.textContent = '';
      playBtn.disabled = true;
      if(!auto) autoPlayBtn.disabled = true;

      // Play spin sound
      if(audioContext.state === 'suspended') {
        audioContext.resume();
      }
      playSpinSound();

      // start "animation"
      drawAnimation(mode, bet, auto);
    }

    function drawAnimation(mode, bet, auto) {
      let ticks = 12;
      const interval = setInterval(() => {
        const r = Math.floor(Math.random()*10);
        drawNumberEl.textContent = r;
        ticks--;
        if(ticks <= 0){
          clearInterval(interval);
          stopSpinSound();
          resolveRound(mode, bet, auto);
        }
      }, 80);
    }

    function resolveRound(mode, bet, auto) {
      const drawn = Math.floor(Math.random()*10);
      drawNumberEl.textContent = drawn;
      let win = false, delta = 0, choiceText = '-';
      if(mode === 'parity'){
        const parity = drawn % 2 === 0 ? 'even' : 'odd';
        choiceText = lastChoice === 'even' ? 'Ch·∫µn' : 'L·∫ª';
        if((lastChoice==='even' && parity==='even') || (lastChoice==='odd' && parity==='odd')){
          win = true; delta = Math.round(bet * 1.75);
        }
      } else {
        const chosen = Number(betNumber.value);
        choiceText = 'S·ªë ' + chosen;
        if(drawn === chosen){
          win = true; delta = Math.round(bet * 2.55);
        }
      }
      const resultText = win ? 'Th·∫Øng' : 'Thua';

      if(win){
        state.balance += delta;
      }

      // Update UI with colored result box
      payoutInfo.innerHTML = '';
      statusEl.textContent = `K·∫øt qu·∫£: ${resultText}`;
      if(win){
        payoutInfo.innerHTML = `<div class="win-text" role="alert" aria-live="assertive">B·∫°n th·∫Øng: +${delta.toLocaleString()} ƒëi·ªÉm</div>`;
      } else {
        payoutInfo.innerHTML = `<div class="lose-text" role="alert" aria-live="assertive">B·∫°n thua: -${bet.toLocaleString()} ƒëi·ªÉm</div>`;
      }

      // reset play button
      playBtn.disabled = false;
      if(!auto) autoPlayBtn.disabled = false;

      // reset choice only if not auto play or last auto play round
      if(!auto){
        lastChoice = null;
        chooseEven.classList.remove('selected');
        chooseOdd.classList.remove('selected');
        chooseEven.setAttribute('aria-pressed', 'false');
        chooseOdd.setAttribute('aria-pressed', 'false');
        betNumber.value = '0';
      } else {
        // keep lastChoice and betNumber for auto play
      }

      // update stats
      const totalGames = state.history.length + 1;
      const winCount = state.history.filter(h => h.delta > 0).length + (win ? 1 : 0);
      const winRate = totalGames > 0 ? ((winCount / totalGames) * 100).toFixed(2) : '0.00';
      document.getElementById('totalGames').textContent = totalGames;
      document.getElementById('winCount').textContent = winCount;
      document.getElementById('winRate').textContent = winRate + '%';

      // record
      pushHistory({t:Date.now(),mode: mode==='parity'? 'Ch·∫µn/L·∫ª':'Theo s·ªë',bet,choice:choiceText,result:resultText,delta: win? delta: -bet});
      save();
      render();

      // play sound
      if(win){
        playWinSound();
      } else {
        playLoseSound();
      }

      // show banner
      if(win){
        showBanner(`üéâ Ch√∫c m·ª´ng! B·∫°n ƒë√£ th·∫Øng ${delta.toLocaleString()} ƒëi·ªÉm.`, 'success');
      } else {
        showBanner(`R·∫•t ti·∫øc! B·∫°n thua ${bet.toLocaleString()} ƒëi·ªÉm.`, 'error');
      }

      // If auto play, continue or stop
      if(auto){
        autoPlayCount--;
        if(autoPlayCount > 0 && autoPlayRunning){
          setTimeout(runAutoPlay, 1200);
        } else {
          autoPlayRunning = false;
          autoPlayChoice = null;
          autoPlayBtn.textContent = 'Auto x5';
          playBtn.disabled = false;
          autoPlayBtn.disabled = false;
          if(autoPlayCount <= 0){
            showBanner('ƒê√£ ho√†n th√†nh 5 l·∫ßn ch∆°i t·ª± ƒë·ªông', 'success');
          }
          // Reset UI selection after auto play ends
          lastChoice = null;
          chooseEven.classList.remove('selected');
          chooseOdd.classList.remove('selected');
          chooseEven.setAttribute('aria-pressed', 'false');
          chooseOdd.setAttribute('aria-pressed', 'false');
          betNumber.value = '0';
        }
      }
    }

    function showBanner(text,type='success'){
      bannerText.textContent = text;
      banner.className = 'banner show ' + (type==='success'?'success':'error');
      setTimeout(()=>{banner.classList.remove('show')},4500);
    }

    function stopAutoPlay() {
      autoPlayRunning = false;
      autoPlayCount = 0;
      autoPlayChoice = null;
      autoPlayBtn.textContent = 'Auto x5';
      playBtn.disabled = false;
      autoPlayBtn.disabled = false;
    }

    // init
    load();
    render();

    // small UX: allow pressing Enter to play
    document.addEventListener('keydown', e => {
      if(e.key==='Enter' && !autoPlayRunning){
        playRound();
      }
    });

    // replace telegram link with a nicer label if user wants to change it programmatically
    const tgLink = document.getElementById('tg-link');
    if(tgLink && tgLink.href){
      try {
        const url = new URL(tgLink.href);
        if(url.hostname === 't.me' && url.pathname.length>1){
          const username = url.pathname.slice(1);
          tgLink.querySelector('span').textContent = `@${username}`;
        }
      } catch(e) {}
    }
  </script>
 </body>
</html>
